# 文稿自动保存功能验证测试

## 功能说明

实现了三个核心的自动保存优化功能：

1. **离开页面确认**：当有未保存的内容时，提示用户
2. **保存状态提示UI**：实时显示保存状态（保存中/未保存/已保存）
3. **切换章节前自动保存**：切换章节时自动保存当前内容

## 测试用例

### 测试用例 1: 保存状态提示UI

**步骤**：

1. 打开文稿编辑页面，选择一个章节
2. 观察保存状态显示：应显示 "已保存: X 秒前/分钟前"
3. 开始编辑内容
4. 观察状态变化：应立即显示黄色圆点 + "未保存"
5. 点击手动保存按钮
6. 观察状态变化：
   - 先显示蓝色闪烁圆点 + "保存中..."
   - 保存完成后显示时钟图标 + "已保存: 几秒前"

**预期结果**：

- ✅ 状态提示准确反映当前保存状态
- ✅ 视觉反馈清晰（颜色、图标、动画）
- ✅ 时间显示使用中文相对时间格式

### 测试用例 2: 自动保存功能

**步骤**：

1. 打开章节编辑器
2. 输入一些内容
3. 等待 30 秒
4. 观察状态变化

**预期结果**：

- ✅ 30 秒后自动触发保存
- ✅ 自动保存时不显示 toast 提示（静默保存）
- ✅ 保存状态从"未保存"变为"已保存"
- ✅ 最后保存时间更新

### 测试用例 3: 离开页面确认

**步骤**：

1. 打开章节编辑器
2. 输入一些新内容（不要保存）
3. 尝试刷新页面或关闭浏览器标签页

**预期结果**：

- ✅ 浏览器显示确认对话框："您有未保存的更改，确定要离开吗？"
- ✅ 点击"取消"留在当前页面
- ✅ 点击"离开"允许离开页面

**步骤（无未保存内容）**：

1. 打开章节编辑器
2. 不做任何修改（或者修改后手动保存）
3. 刷新页面或关闭标签页

**预期结果**：

- ✅ 直接离开，不显示确认对话框

### 测试用例 4: 切换章节前自动保存

**步骤**：

1. 打开章节编辑器，编辑当前章节
2. 观察状态显示"未保存"
3. 点击侧边栏切换到另一个章节

**预期结果**：

- ✅ 自动触发保存当前章节
- ✅ 显示 toast 提示："已自动保存当前章节"
- ✅ 成功切换到新章节
- ✅ 新章节内容正确加载

**步骤（保存失败情况）**：

1. 断开网络连接或后端服务
2. 编辑章节内容
3. 尝试切换到另一个章节

**预期结果**：

- ✅ 显示确认对话框："当前章节保存失败，是否仍要切换到其他章节？未保存的内容可能会丢失。"
- ✅ 点击"取消"留在当前章节
- ✅ 点击"确定"允许切换章节

### 测试用例 5: 内容变更检测

**步骤**：

1. 加载章节内容
2. 不做任何修改，直接点击保存按钮

**预期结果**：

- ✅ 不发送保存请求（因为内容没有变化）
- ✅ 不显示任何 toast 提示
- ✅ 状态保持"已保存"

**步骤**：

1. 加载章节内容
2. 修改内容
3. 撤销修改（恢复到原始内容）
4. 点击保存按钮

**预期结果**：

- ✅ 不发送保存请求（因为内容与已保存内容相同）
- ✅ 状态从"未保存"变回"已保存"

### 测试用例 6: AI 操作后的保存状态

**步骤**：

1. 打开章节编辑器
2. 使用 AI 续写/润色/扩写功能
3. 观察保存状态

**预期结果**：

- ✅ AI 生成内容插入后，状态显示"未保存"
- ✅ 可以正常触发自动保存
- ✅ 切换章节时会提示保存

## 实现细节

### 核心状态管理

```typescript
const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
const savedContentRef = useRef(content); // 记录已保存的内容
```

### 关键函数

1. **handleSave**：
   - 接受 `showToast` 参数控制是否显示提示
   - 比较 `contentRef.current` 和 `savedContentRef.current`
   - 只在内容有变化时才发送请求

2. **handleContentChange**：
   - 实时更新 `hasUnsavedChanges` 状态
   - 设置 30 秒自动保存定时器
   - 自动保存时 `showToast = false`

3. **handleSelectChapter**：
   - 检查 `hasUnsavedChanges`
   - 有未保存内容时先调用 `handleSave(false)`
   - 保存失败时显示确认对话框

4. **beforeunload 事件监听**：
   - 当 `hasUnsavedChanges = true` 时拦截页面离开
   - 显示浏览器原生确认对话框

### 状态指示器

- **保存中**：蓝色闪烁圆点 + "保存中..."
- **未保存**：黄色圆点 + "未保存"
- **已保存**：时钟图标 + "已保存: X 秒前"（中文相对时间）

## 功能验证检查清单

- [x] 保存状态UI正确显示
- [x] 自动保存功能正常工作（30秒触发）
- [x] 离开页面时正确提示
- [x] 切换章节前自动保存
- [x] 保存失败时的错误处理
- [x] 内容变更检测准确
- [x] 类型检查通过
- [x] 时间显示使用中文格式
