# 接口开发与安全规范

## 9. 接口开发规范

- 🗄️ **数据库优先**：开发接口前必须先查看 `apps/backend/prisma/schema.prisma` 了解数据库表结构
- 🔗 **三端统一**：确保前端类型定义、后端接口、数据库字段完全对应
- 📋 **字段映射**：检查 `packages/types` 中的类型定义与数据库字段是否匹配
- ✅ **值对齐检查**：Select/Enum字段的可选值必须与数据库存储的实际值完全一致
- 🎯 **存储原则**：Select组件存储 `value` 而非 `label`，确保数据库存储的是值标识而非显示文本
- 🔍 **全面验证**：新增接口后需查询数据库实际数据，验证所有枚举/选择字段的值都有对应的前端选项定义

## 10. 代码修改范围控制

- 🎯 **精准修改**：只修改与任务直接相关的代码，不进行"顺手优化"或无关改动
- 📍 **影响范围**：修改前明确说明影响范围，避免意外破坏其他功能
- ⚠️ **重构警告**：大规模重构（如文件重命名、架构调整）必须事先征得用户同意
- 🔒 **最小改动**：优先选择影响面最小的实现方案

## 11. 危险操作确认机制

- 🗑️ **文件删除**：删除文件前必须列出文件列表并等待用户确认
- 🔄 **文件重命名**：重命名文件/目录需说明影响的import路径和相关引用
- 💾 **数据库操作**：执行migration、数据删除、字段变更等操作前必须明确说明并征得确认
- 🚨 **不可逆操作**：任何不可逆操作（删除、覆盖、重置）都需要明确警告并征得同意
- ⚡ **批量操作**：批量修改、批量删除等操作需要先预览影响范围

## 12. 增量开发原则

- 📦 **小步迭代**：优先小步快跑，一次只解决一个问题，避免一次性大改
- ✅ **逐步验证**：每个小改动后立即验证（lint/typecheck/功能测试），而非积累多个改动
- 🔙 **可回滚性**：保持每次修改都可以独立回滚，避免多个改动耦合在一起
- 🎛️ **功能开关**：大功能使用feature flag或配置开关逐步发布，降低风险

## 13. 数据库安全规范

- 🔒 **查询安全**：必须使用Prisma参数化查询，严禁字符串拼接SQL防止注入
- 🛡️ **输入验证**：所有用户输入必须经过Zod schema验证，不信任任何前端数据
- 📊 **性能考虑**：避免N+1查询问题，使用`include`或`select`预加载关联数据
- 🔍 **索引意识**：查询条件中的字段应该有对应索引支持，避免全表扫描
- 🚫 **SQL注入**：禁止使用`$executeRawUnsafe`或`$queryRawUnsafe`拼接用户输入

## 14. API变更规范

- 🔄 **向后兼容**：API修改必须保持向后兼容，或提供明确的迁移方案和过渡期
- 📋 **接口文档**：修改API后同步更新Swagger/JSDoc注释，保持文档与代码一致
- 🧪 **测试覆盖**：核心API变更需要手动验证或编写测试用例确保功能正常
- 🔔 **变更通知**：破坏性变更必须明确告知用户，说明变更原因和影响范围
- 📝 **版本管理**：重大API变更考虑使用版本号（如`/api/v2/`）区分新旧接口
