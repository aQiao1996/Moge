# 开发指南

本文件定义了应用的核心架构决策、开发规范与实施策略。

---

## 1. 全局核心系统

### 1.1. `@` 智能引用系统

这是打通所有模块、提升产品价值的核心系统。

- **目标**: 实现 `设定集`、`大纲`、`正文` 之间的无缝链接。
- **核心流程**:
  1.  **触发与插入**: 在任何编辑器中输入 `@`，触发全局设定搜索，选择后插入一个包含唯一ID的稳定链接（如 `[@风雪城](moge://item/uuid-xxx)`）。
  2.  **悬浮与跳转**: 在阅读时，鼠标悬浮于 `@链接` 上可预览设定简介卡片；点击则直接跳转至该设定的详情页。
  3.  **反向链接**: 在设定的详情页，能自动展示所有引用了该设定的“出场章节”列表。
- **技术要点**: 需要后端提供统一搜索接口、前端实现编辑器插件和 Markdown 自定义渲染组件。

### 1.2. 字典管理与设定集的协同设计

**数据层级关系**:

- **字典管理**: 维护全局标准化数据（小说类型、通用标签、模板等）
- **设定集**: 使用字典数据，并可扩展项目专属内容
- **协同机制**: 设定集中的标签选择器从字典管理获取选项，支持快速添加自定义标签

**典型使用流程**:

1. 在字典管理中维护小说类型和标签库
2. 创建项目时从字典中选择类型和基础标签
3. 在设定集中创建角色/系统/世界时，标签选择器自动加载相关词汇
4. 支持在设定创建过程中临时添加新词汇，可选择是否加入个人字典

### 1.3. AI 开发规范

**核心原则**: AI 功能的核心目标是辅助用户创作，提升内容生产效率和一致性，而不是取代用户。

**规划功能与规范**:

- **设定上下文注入**:
  - **规范**: 在调用 AI 生成内容（如大纲、章节）时，必须自动获取当前项目关联的所有设定集（角色、世界观、系统等）作为上下文信息，提供给 AI 模型。
  - **目标**: 确保 AI 生成的内容符合用户已经创建的独特世界观，保证故事的一致性。
- **AI 生成增强**:
  - **支持设定摘要注入**，提升 AI 生成内容的一致性。
  - **智能识别相关设定**，优先使用高相关度的设定信息。
  - **生成结果自动解析**并建立 @ 引用关系。

---

## 2. 核心开发规则

### 2.1. 代码质量与维护性

- **中文注释规范**: 为所有核心函数、复杂逻辑添加完整的中文JSDoc注释，包含功能描述、参数说明、返回值说明。
- **类型安全**: 必须保证完整的TypeScript类型定义和验证，通过所有严格类型检查。
- **错误处理**: 建立统一的错误处理机制，避免在业务代码中出现零散的、重复的错误提示（如 toast）。
- **组件复用**: 优先使用项目中已有的UI组件（如 `MogeFormDialog`）和业务组件，保证UI和交互的一致性。
- **性能优化**: 遵循React最佳实践（如 `useCallback`, `useMemo`, 函数式 `setState`），避免不必要的重渲染和无限循环。

### 2.2. API 架构规范

- **统一入口**: 建立统一的数据获取入口（如 `settings.api.ts`），支持并行和单独请求。
- **后端规范**:
  - **技术栈**: 使用 NestJS Controller/Service 架构。
  - **认证**: 所有需授权接口基于 JWT 认证，自动从 token 获取用户信息。
  - **ORM**: 使用 Prisma ORM，并使用其生成的类型系统（如 `Prisma.character_settingsCreateInput`）。
  - **权限**: 确保用户只能操作自己的数据。
  - **文档**: 需提供完整的 Swagger API 文档和类型定义。
- **字段映射**: 保证前后端字段完全对齐，统一使用数据库 schema 中定义的字段名（如 `remarks`）。

### 2.3. 表单与弹框开发

- **表单验证**: 使用 Zod 进行完整的数据验证。
- **组件升级**: 对基础组件（如 `MogeFormDialog`）的升级改造，需要支持更灵活的配置（如 `section` 分组），并保持向下兼容。
- **多选组件 (`MogeMultiSelect`)**:
  - **功能**: 必须支持搜索过滤、标签展示、批量选择/清除等功能。
  - **体验**: 需处理好加载状态、空状态和错误状态，并做好响应式设计。

---

## 3. 架构设计与方案对比

### 3.1. `设定集` 模块架构

- **双重架构**: 采用“项目关联设定 + 独立设定库”的双重架构，兼顾项目内管理和跨项目复用。
- **界面架构**:
  - **首页 (`/settings`)**: 小说项目列表，作为设定集的入口。
  - **分类页 (`/settings/[projectId]`)**: 展示单个项目下的四大设定分类（角色、系统、世界、辅助）。
  - **独立设定库 (`/settings/library`)**: 跨项目的独立设定管理系统，同样按四大分类组织。
- **视图模式**: 列表需支持卡片视图和表格（或列表）视图两种模式，并提供搜索、筛选、排序等基础功能。
- **子路由结构**: 采用 `settings/characters/[id]` 这样的清晰层级，分离"主页"、"列表页"和"详情页"。

### 3.2. `世界设定` 功能设计方案对比

在设计 `世界设定` 的数据结构时，对多种方案进行了对比：

- **方案一：分层级结构方案**
  - **结构**: 世界总览 → 大陆/星球 → 国家/王国 → 地区/省份 → 城市/据点
  - **优点**: 层次清晰，适合大型复杂世界观。
  - **缺点**: 对简单世界观过于复杂，操作繁琐。
  - **结论**: 未采用。

- **方案二：分类模块方案** ⭐ **已采用**
  - **结构**: 基础信息 | 地理环境 | 政治势力 | 文化体系 | 修炼/力量体系 | 历史脉络
  - **优点**: 模块化易于理解，通用性强，可选择性填写，扩展性好。
  - **缺点**: 信息可能在不同模块间有重复。
  - **结论**: 作为主体架构，通用性最强。

- **方案三：时间线导向方案**
  - **结构**: 以时间线（远古、古代、当前）为主轴，关联空间设定。
  - **优点**: 历史脉络清晰，适合历史厚重的设定。
  - **缺点**: 对现代/未来题材不够直观。
  - **结论**: 未采用。

- **方案四：势力中心方案**
  - **结构**: 以主要势力为核心，展开描述中立区域和跨势力设定。
  - **优点**: 适合势力斗争主线，符合网文常见模式。
  - **缺点**: 可能忽略自然环境，对个人冒险类故事不适用。
  - **结论**: 未采用。

---

## 4. 实施策略与进度

建议采用分阶段、迭代的方式进行开发：

### 4.1. 第一阶段 (基础建设) - 部分完成 ✅

**已完成**:

- ✅ 搭建 `设定集` 模块的基础页面和路由结构
  - 设定集首页 (`/settings`)：项目列表展示，支持搜索、筛选、排序
  - 项目卡片操作：支持项目的编辑和删除功能，使用确认弹窗防止误删
  - 项目分类页 (`/settings/[projectId]`)：展示项目的四大设定分类
  - 设定库页 (`/settings/library`)：独立设定管理入口
  - 设定库分类列表页 (`/settings/library/[category]`)：支持搜索、标签筛选、排序，支持列表/卡片视图切换
- ✅ 实现 `设定集` 的完整后端 API
  - Settings 模块：角色、系统、世界、辅助设定的完整 CRUD
  - Projects 模块：项目管理和设定关联功能，包括创建、更新、删除和查询
  - 关联检查：删除设定时自动检查项目关联
- ✅ 实现前端数据对接
  - API 层：完整的接口封装（`settings.api.ts`、`projects.api.ts`）
  - 页面对接：设定集首页和设定库页面已对接真实数据
  - 数据回显：项目编辑时完整回显所有字段数据（包括关联的设定）
- ✅ 实现 `设定集` 模块的设定创建和编辑功能
  - 角色设定：完整的创建/编辑对话框，支持关系管理
  - 系统设定：完整的创建/编辑对话框
  - 世界设定：完整的创建/编辑对话框
  - 辅助设定：完整的创建/编辑对话框
- ✅ 实现项目管理的完整功能
  - 项目创建：支持设置项目名称、类型、描述和关联设定
  - 项目编辑：支持修改所有项目信息，数据完整回显
  - 项目删除：使用 `MogeConfirmPopover` 组件提供二次确认，防止误操作
  - 项目详情弹窗：支持查看项目完整信息和关联的设定列表
  - UI一致性：编辑和删除按钮始终可见，样式与设定库页面保持一致
- ✅ 实现项目详情弹窗功能
  - 基于 Tabs 的多标签页设计，包含项目信息和四大设定分类
  - 项目信息 Tab：展示基本信息（名称、类型、描述、标签、创建时间）和设定统计
  - 设定管理 Tabs：展示每个分类已关联的设定列表
  - 设定选择器：从设定库选择设定添加到项目，支持搜索过滤和多选
  - 响应式设计：Tab 支持横向滚动，内容区域支持纵向滚动

**待完成**:

- ⏳ 实现项目设定关联的后端 API 调用
  - 添加设定到项目（更新项目的 characters/systems/worlds/misc 数组）
  - 从项目移除设定关联
- ⏳ 实现移除设定关联功能的前端交互
  - 添加确认弹窗
  - 刷新数据和提示信息
- ⏳ 实现 `文稿` 模块的列表及状态管理

**技术实现要点**:

1. **数据库设计**：
   - 采用 Prisma ORM，四类设定表独立存储（`character_settings`, `system_settings`, `world_settings`, `misc_settings`）
   - Projects 表使用字符串数组存储关联的设定ID（`characters: String[]`）

2. **API 架构**：
   - 后端：NestJS Controller/Service 架构，JWT 认证，完整的 Swagger 文档
   - 前端：统一的 API 封装，支持并行请求和错误处理

3. **关联管理**：
   - 删除保护：设定被项目关联时不允许删除，提示用户解除关联
   - 反向查询：支持查询设定的关联项目列表

4. **UI组件规范**：
   - 统一使用 `MogeConfirmPopover` 处理删除确认
   - 操作按钮保持可见，提供更好的用户体验
   - 编辑功能使用 `ProjectDialog` 组件，支持创建和编辑两种模式
   - 弹窗设计遵循响应式原则，支持滚动和自适应布局

5. **项目详情弹窗实现**：
   - **组件**: `ProjectDetailDialog` 和 `SettingSelectorDialog`
   - **Tab 组件**: 创建了基于 Radix UI 的 Tabs 组件 (`apps/frontend/src/components/ui/tabs.tsx`)
   - **数据加载**: 使用 `getProjectSettings` API 获取项目关联的完整设定数据
   - **设定选择**: 支持从设定库搜索、筛选和多选设定
   - **交互优化**:
     - Tab 标签支持横向滚动，文字简洁（如"角色"而非"角色设定"）
     - 选中设定时显示视觉反馈（背景高亮、勾选图标）
     - 设定统计卡片采用纵向居中布局，间距宽松
     - 设定卡片显示名称、描述、标签和移除按钮

### 4.2. 第二阶段 (核心价值) - 待开发

- ⏳ 实现 `@` 智能引用系统的 MVP 版本
- ⏳ 实现 AI 生成时的设定上下文注入功能
- ⏳ 实现 `工作台` 的"最近项目"和"统计概览"模块

### 4.3. 第三阶段 (体验增强) - 待开发

- ⏳ 为 `@` 系统增加悬浮预览卡片和反向链接功能
- ⏳ 实现设定使用统计和关联度分析
- ⏳ 完善独立的 `统计` 页面
- ⏳ 完成 `工作台` 的其余模块
