# 开发指南

本文件定义了应用的核心架构决策、开发规范与实施策略。

---

## 1. 全局核心系统

### 1.1. `@` 智能引用系统

这是打通所有模块、提升产品价值的核心系统。

- **目标**: 实现 `设定集`、`大纲`、`正文` 之间的无缝链接。
- **核心流程**:
  1.  **触发与插入**: 在任何编辑器中输入 `@`，触发全局设定搜索，选择后插入一个包含唯一ID的稳定链接（如 `[@风雪城](moge://item/uuid-xxx)`）。
  2.  **悬浮与跳转**: 在阅读时，鼠标悬浮于 `@链接` 上可预览设定简介卡片；点击则直接跳转至该设定的详情页。
  3.  **反向链接**: 在设定的详情页，能自动展示所有引用了该设定的“出场章节”列表。
- **技术要点**: 需要后端提供统一搜索接口、前端实现编辑器插件和 Markdown 自定义渲染组件。

### 1.2. 字典管理与设定集的协同设计

**数据层级关系**:

- **字典管理**: 维护全局标准化数据（小说类型、通用标签、模板等）
- **设定集**: 使用字典数据，并可扩展项目专属内容
- **协同机制**: 设定集中的标签选择器从字典管理获取选项，支持快速添加自定义标签

**典型使用流程**:

1. 在字典管理中维护小说类型和标签库
2. 创建项目时从字典中选择类型和基础标签
3. 在设定集中创建角色/系统/世界时，标签选择器自动加载相关词汇
4. 支持在设定创建过程中临时添加新词汇，可选择是否加入个人字典

### 1.3. AI 开发规范

**核心原则**: AI 功能的核心目标是辅助用户创作，提升内容生产效率和一致性，而不是取代用户。

**规划功能与规范**:

- **设定上下文注入**:
  - **规范**: 在调用 AI 生成内容（如大纲、章节）时，必须自动获取当前项目关联的所有设定集（角色、世界观、系统等）作为上下文信息，提供给 AI 模型。
  - **目标**: 确保 AI 生成的内容符合用户已经创建的独特世界观，保证故事的一致性。
- **AI 生成增强**:
  - **支持设定摘要注入**，提升 AI 生成内容的一致性。
  - **智能识别相关设定**，优先使用高相关度的设定信息。
  - **生成结果自动解析**并建立 @ 引用关系。

---

## 2. 核心开发规则

### 2.1. 代码质量与维护性

- **中文注释规范**: 为所有核心函数、复杂逻辑添加完整的中文JSDoc注释，包含功能描述、参数说明、返回值说明。
- **类型安全**: 必须保证完整的TypeScript类型定义和验证，通过所有严格类型检查。
- **错误处理**: 建立统一的错误处理机制，避免在业务代码中出现零散的、重复的错误提示（如 toast）。
- **组件复用**: 优先使用项目中已有的UI组件（如 `MogeFormDialog`）和业务组件，保证UI和交互的一致性。
- **性能优化**: 遵循React最佳实践（如 `useCallback`, `useMemo`, 函数式 `setState`），避免不必要的重渲染和无限循环。

### 2.2. API 架构规范

- **统一入口**: 建立统一的数据获取入口（如 `settings.api.ts`），支持并行和单独请求。
- **后端规范**:
  - **技术栈**: 使用 NestJS Controller/Service 架构。
  - **认证**: 所有需授权接口基于 JWT 认证，自动从 token 获取用户信息。
  - **ORM**: 使用 Prisma ORM，并使用其生成的类型系统（如 `Prisma.character_settingsCreateInput`）。
  - **权限**: 确保用户只能操作自己的数据。
  - **文档**: 需提供完整的 Swagger API 文档和类型定义。
- **字段映射**: 保证前后端字段完全对齐，统一使用数据库 schema 中定义的字段名（如 `remarks`）。

### 2.3. 表单与弹框开发

- **表单验证**: 使用 Zod 进行完整的数据验证。
- **组件升级**: 对基础组件（如 `MogeFormDialog`）的升级改造，需要支持更灵活的配置（如 `section` 分组），并保持向下兼容。
- **多选组件 (`MogeMultiSelect`)**:
  - **功能**: 必须支持搜索过滤、标签展示、批量选择/清除等功能。
  - **体验**: 需处理好加载状态、空状态和错误状态，并做好响应式设计。

---

## 3. 架构设计与方案对比

### 3.1. `设定集` 模块架构

- **双重架构**: 采用“项目关联设定 + 独立设定库”的双重架构，兼顾项目内管理和跨项目复用。
- **界面架构**:
  - **首页 (`/settings`)**: 小说项目列表，作为设定集的入口。
  - **分类页 (`/settings/[projectId]`)**: 展示单个项目下的四大设定分类（角色、系统、世界、辅助）。
  - **独立设定库 (`/settings/library`)**: 跨项目的独立设定管理系统，同样按四大分类组织。
- **视图模式**: 列表需支持卡片视图和表格（或列表）视图两种模式，并提供搜索、筛选、排序等基础功能。
- **子路由结构**: 采用 `settings/characters/[id]` 这样的清晰层级，分离"主页"、"列表页"和"详情页"。

### 3.2. `世界设定` 功能设计方案对比

在设计 `世界设定` 的数据结构时，对多种方案进行了对比：

- **方案一：分层级结构方案**
  - **结构**: 世界总览 → 大陆/星球 → 国家/王国 → 地区/省份 → 城市/据点
  - **优点**: 层次清晰，适合大型复杂世界观。
  - **缺点**: 对简单世界观过于复杂，操作繁琐。
  - **结论**: 未采用。

- **方案二：分类模块方案** ⭐ **已采用**
  - **结构**: 基础信息 | 地理环境 | 政治势力 | 文化体系 | 修炼/力量体系 | 历史脉络
  - **优点**: 模块化易于理解，通用性强，可选择性填写，扩展性好。
  - **缺点**: 信息可能在不同模块间有重复。
  - **结论**: 作为主体架构，通用性最强。

- **方案三：时间线导向方案**
  - **结构**: 以时间线（远古、古代、当前）为主轴，关联空间设定。
  - **优点**: 历史脉络清晰，适合历史厚重的设定。
  - **缺点**: 对现代/未来题材不够直观。
  - **结论**: 未采用。

- **方案四：势力中心方案**
  - **结构**: 以主要势力为核心，展开描述中立区域和跨势力设定。
  - **优点**: 适合势力斗争主线，符合网文常见模式。
  - **缺点**: 可能忽略自然环境，对个人冒险类故事不适用。
  - **结论**: 未采用。

### 3.3. `文稿` 模块架构设计

**核心定位**: 文稿模块是作者进行正文创作的核心工作区,将大纲转化为完整小说内容的地方。

**主要功能职责**:

1. **文稿项目管理**
   - 文稿列表展示(卡片/列表视图)
   - 文稿 CRUD(创建、编辑、删除)
   - 状态管理(构思中/进行中/已完结/已发布)
   - 筛选排序(按名称、状态、更新时间、字数等)
   - 关联大纲和设定集项目

2. **章节结构管理**
   - 卷章树形结构展示
   - 创建/删除/重命名卷和章节
   - 拖拽排序
   - 支持特殊章节类型(序章/楔子、正文章节、番外/后记)

3. **正文编辑与写作** (核心)
   - Markdown 编辑器(实时预览、快捷键、自动保存)
   - 字数统计(实时显示当前章节/当天/总字数)
   - 版本历史(支持内容版本管理和回滚)
   - 专注模式(全屏写作,隐藏干扰元素)
   - 自动保存(每 30 秒或内容变更时)

4. **AI 辅助创作**
   - AI 续写(根据上文和设定续写后续内容)
   - AI 润色(优化文字表达、修正语法错误)
   - AI 扩写(将简短大纲扩写为完整章节)
   - AI 改写(根据指令调整文风、视角等)
   - 上下文注入(自动注入关联的设定、前几章剧情摘要、大纲要点)

5. **设定关联与引用** (与 @ 系统集成)
   - 在编辑器中输入 `@` 触发设定搜索
   - 插入设定引用(如 `[@李小凡](moge://character/123)`)
   - 悬浮预览设定详情
   - 点击跳转到设定页面
   - 反向链接(在设定详情页显示"该角色在哪些章节出场")

6. **发布与导出**
   - 章节发布(标记章节为"已发布"状态)
   - 定时发布
   - 导出功能(TXT/EPUB/DOCX,支持选择导出范围)
   - 发布记录(记录每次发布的时间、字数、章节)

7. **统计与分析**
   - 字数统计(今日字数、本周字数、总字数、字数趋势图)
   - 写作习惯分析(写作活跃时间分布、平均每日字数、更新频率)
   - 进度跟踪(目标字数设定、完成进度百分比、预计完结时间)

**数据库设计**:

- `manuscripts` 表: 文稿元数据(名称、描述、状态、关联大纲 ID、关联项目 ID、总字数等)
- `manuscript_volumes` 表: 卷信息(参考 outline_volume 设计)
- `manuscript_chapters` 表: 章节元数据(参考 outline_chapter 设计)
- `manuscript_chapter_content` 表: 章节内容(content 字段、版本号)
- `manuscript_chapter_content_version` 表: 章节内容版本历史

**页面结构**:

```
/manuscripts
├── page.tsx                  # 文稿列表页
├── [id]/
│   ├── page.tsx             # 文稿详情页(展示卷章结构 + 统计)
│   ├── edit/
│   │   └── page.tsx         # 章节编辑器(左侧大纲树,右侧编辑器)
│   └── settings/
│       └── page.tsx         # 文稿设置(关联大纲、设定等)
├── components/
│   ├── ManuscriptCard.tsx   # 文稿卡片
│   ├── ChapterTree.tsx      # 章节树
│   ├── Editor.tsx           # Markdown 编辑器
│   ├── AIAssistPanel.tsx    # AI 辅助面板
│   └── StatsPanel.tsx       # 统计面板
└── api/
    └── manuscripts.api.ts   # API 封装
```

**与其他模块的协作关系**:

- **与大纲模块**: 从大纲创建文稿(自动复制卷章结构)、同步更新、反向关联
- **与设定集**: 设定注入、@ 引用、设定提醒
- **与工作台**: 显示最近编辑的文稿章节、今日字数统计、快速继续写作入口

**开发优先级**:

- **Phase 1 - 基础功能** (MVP): 文稿项目管理、卷章结构管理、Markdown 编辑器、自动保存和字数统计
- **Phase 2 - AI 增强**: AI 续写功能、设定上下文注入、AI 润色/扩写
- **Phase 3 - 高级功能**: @ 引用系统集成、导出功能、版本历史、统计分析面板

---

## 4. 实施策略与进度

建议采用分阶段、迭代的方式进行开发：

### 4.1. 第一阶段 (基础建设) - 部分完成 ✅

**已完成**:

- ✅ 搭建 `设定集` 模块的基础页面和路由结构
  - 设定集首页 (`/settings`)：项目列表展示，支持搜索、筛选、排序
  - 项目卡片操作：支持项目的编辑和删除功能，使用确认弹窗防止误删
  - 项目分类页 (`/settings/[projectId]`)：展示项目的四大设定分类
  - 设定库页 (`/settings/library`)：独立设定管理入口
  - 设定库分类列表页 (`/settings/library/[category]`)：支持搜索、标签筛选、排序，支持列表/卡片视图切换
- ✅ 实现 `设定集` 的完整后端 API
  - Settings 模块：角色、系统、世界、辅助设定的完整 CRUD
  - Projects 模块：项目管理和设定关联功能，包括创建、更新、删除和查询
  - 关联检查：删除设定时自动检查项目关联
- ✅ 实现前端数据对接
  - API 层：完整的接口封装（`settings.api.ts`、`projects.api.ts`）
  - 页面对接：设定集首页和设定库页面已对接真实数据
  - 数据回显：项目编辑时完整回显所有字段数据（包括关联的设定）
- ✅ 实现 `设定集` 模块的设定创建和编辑功能
  - 角色设定：完整的创建/编辑对话框，支持关系管理
  - 系统设定：完整的创建/编辑对话框
  - 世界设定：完整的创建/编辑对话框
  - 辅助设定：完整的创建/编辑对话框
- ✅ 实现项目管理的完整功能
  - 项目创建：支持设置项目名称、类型、描述和关联设定
  - 项目编辑：支持修改所有项目信息，数据完整回显
  - 项目删除：使用 `MogeConfirmPopover` 组件提供二次确认，防止误操作
  - 项目详情弹窗：支持查看项目完整信息和关联的设定列表
  - UI一致性：编辑和删除按钮始终可见，样式与设定库页面保持一致
- ✅ 实现项目详情弹窗功能
  - 基于 Tabs 的多标签页设计，包含项目信息和四大设定分类
  - 项目信息 Tab：展示基本信息（名称、类型、描述、标签、创建时间）和设定统计
  - 设定管理 Tabs：展示每个分类已关联的设定列表
  - 设定选择器：从设定库选择设定添加到项目，支持搜索过滤和多选
  - 添加设定功能：调用后端 API 更新项目关联的设定，成功后显示提示并刷新数据
  - 移除设定功能：使用确认弹窗防止误操作，移除后自动刷新项目列表
  - 数据同步：修改设定关联后自动刷新父组件的项目列表
  - 响应式设计：Tab 支持横向滚动，内容区域支持纵向滚动
- ✅ 完善字典管理系统
  - 数据规范化：移除 `dict_items` 表中冗余的 `code` 字段，统一使用 `value` 字段存储值
  - 字典分类完善：添加 `novel_eras`（小说时代）和 `novel_tags`（小说标签）分类及初始数据
  - 数据动态化：将大纲模块的硬编码筛选选项（类型、时代、标签）迁移到字典系统
  - 前端状态管理：在 `dictStore` 中添加 `fetchNovelEras` 和 `fetchNovelTags` 方法，支持数据缓存
  - 初始化脚本：提供 `init-novel-eras.ts` 和 `init-novel-tags.ts` 脚本用于环境初始化
  - 页面布局优化：修复字典管理首页和分类详情页的滚动问题，确保内容超出时正确显示滚动条
  - 类型显示优化：大纲列表页正确显示小说类型的 label 而非 value
- ✅ 实现 `大纲` 模块的设定关联功能
  - 数据库设计：在 outline 表中添加设定关联字段（characters, systems, worlds, misc）
  - 后端 API：提供获取和更新关联设定的完整接口
  - 前端集成：在大纲详情页添加"关联设定" Tab，展示四大设定分类
  - 设定管理：支持从设定库添加/移除关联的设定，操作后自动刷新
  - AI 增强：生成大纲时自动注入关联设定作为上下文，提升内容一致性
  - 上下文构建：实现 `buildSettingsContext` 方法，将设定格式化为 AI 可理解的文本
- ✅ 实现 `大纲` 模块的结构化编辑功能
  - 后端架构：在 `outline.service.ts` 中新增 5 个方法（创建卷、创建章节、创建卷内章节、删除卷、删除章节）
  - API 端点：提供完整的 RESTful API，支持 POST 创建和 DELETE 删除操作
  - 自动排序：创建时自动计算 sortOrder，确保新项目排在末尾
  - 敏感词检查：创建和编辑时使用创作模式检查敏感词，平衡内容安全和创作自由
  - 级联删除：删除卷时自动删除该卷下的所有章节（数据库级联约束）
  - 前端组件：创建 `CreateItemDialog` 和 `DeleteConfirmDialog` 两个对话框组件
  - 自动序号：创建时自动生成中文序号（第一卷、第二卷等），使用 `numberToChinese` 转换函数
  - 确认机制：删除操作使用确认对话框，明确提示删除卷会连带删除章节
  - 数据刷新：创建/删除后自动调用 `refreshData` 刷新大纲结构
  - 自动展开：创建新卷后自动展开该卷，提升用户体验
  - 侧边栏优化：修复编辑结构侧边栏的滚动问题，使用 `flex flex-col` 和 `overflow-y-auto` 确保内容可滚动
  - 类型安全：遵循 TypeScript 类型规范，避免使用 `as any`，明确定义 `ChapterContentType` 类型
  - 代码质量：通过 `pnpm run lint` 和 `pnpm run typecheck` 检查，符合项目规范

**待完成**:

- ✅ 实现 `文稿` 模块 (Phase 1: 基础功能) - 后端完成 ✅ 前端部分完成 ⏳
  - ✅ 数据库设计：manuscripts、manuscript_volume、manuscript_chapter、manuscript_chapter_content、manuscript_chapter_content_version 表
  - ✅ 类型定义：在 `packages/types/src/schemas/manuscript.ts` 中定义完整的 Zod schema 和类型
  - ✅ 后端 API：
    - ✅ Manuscripts Module (NestJS): Controller、Service、DTO
    - ✅ 文稿 CRUD：创建、查询、更新、软删除
    - ✅ 从大纲创建文稿：自动复制卷章结构
    - ✅ 卷管理：创建、更新、删除卷
    - ✅ 章节管理：创建、更新、删除章节
    - ✅ 内容管理：保存内容、获取内容、版本历史
    - ✅ 章节发布：标记章节为已发布状态
    - ✅ 字数统计：自动计算和更新 totalWords、publishedWords
    - ✅ 设定关联：支持 projectId 优先级和独立设定数组
    - ✅ 类型检查：通过后端 TypeScript 类型检查
  - ⏳ 前端实现：
    - ✅ API 客户端：完整的 API 封装 (manuscripts/api/client.ts)
    - ✅ 文稿列表页：展示文稿卡片、字数统计、进度条、操作按钮、删除确认
    - ✅ 文稿详情页（基础）：展示文稿信息、统计卡片、创作进度、Tab 切换
    - ✅ 创建/编辑文稿对话框：支持空白创建、从大纲创建、编辑文稿、关联设定
    - ✅ 卷章树形展示组件：ChapterTree 组件，支持展开/折叠、显示字数统计
    - ✅ 创建卷/章节功能：复用大纲模块的 CreateItemDialog，支持自动序号生成
    - ✅ 删除卷/章节功能：复用大纲模块的 DeleteConfirmDialog，带二次确认
    - ✅ 章节编辑器：Markdown 编辑器（复用 MdEditor）、实时字数统计、最后保存时间显示
    - ✅ 自动保存功能：内容变更后 30 秒自动保存，避免数据丢失
    - ✅ 侧边栏集成：ManuscriptEditSidebar 组件，在编辑器页面展示卷章树，支持快速切换章节
    - ✅ 侧边栏展开/折叠：支持展开/折叠侧边栏，优化编辑空间
    - ⏳ 编辑卷/章节功能：编辑卷标题和描述、编辑章节标题
    - ⏳ 拖拽排序功能：卷的拖拽排序、章节的拖拽排序
- ⏳ 实现 `文稿` 模块 (Phase 2: AI 增强)
  - AI 续写功能
  - 设定上下文注入
  - AI 润色/扩写
- ⏳ 实现 `文稿` 模块 (Phase 3: 高级功能)
  - @ 引用系统集成
  - 导出功能 (TXT/EPUB/DOCX)
  - 版本历史查看和回滚
  - 统计分析面板（字数趋势图、写作习惯分析）
- ⏳ 实现 `工作台` 模块
  - 最近项目列表
  - 统计概览卡片
  - 创作目标/待办清单
  - 灵感便签
- ⏳ 实现 `统计` 模块
  - 字数统计和趋势图
  - 写作习惯分析
  - 项目贡献度分析

### 4.2. 第二阶段 (核心价值) - 待开发

- ⏳ 实现 `@` 智能引用系统的 MVP 版本
  - 后端统一搜索接口
  - 编辑器插件 (输入 @ 触发搜索)
  - Markdown 自定义渲染组件
  - 插入稳定链接 (moge://item/uuid-xxx)
- ⏳ 完善 AI 生成时的设定上下文注入功能
  - 智能识别相关设定
  - 优先使用高相关度的设定信息
- ⏳ 实现 `工作台` 的"最近项目"和"统计概览"模块

### 4.3. 第三阶段 (体验增强) - 待开发

- ⏳ 为 `@` 系统增加悬浮预览卡片和反向链接功能
  - 鼠标悬浮预览设定简介卡片
  - 点击跳转至设定详情页
  - 反向链接：设定详情页显示所有引用该设定的章节
- ⏳ 实现设定使用统计和关联度分析
- ⏳ 完善独立的 `统计` 页面
  - 按时间范围查看字数趋势图
  - 项目贡献度分析
  - 写作活跃时间分布
- ⏳ 完成 `工作台` 的其余模块
