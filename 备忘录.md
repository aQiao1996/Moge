# 墨阁 (Moge) 功能规划备忘录

本文档旨在沉淀和梳理“墨阁”应用未来的功能规划与设计思路，作为后续开发的统一参考。

---

## 第一部分：核心功能现状

应用目前已具备稳定可靠的核心功能：

1.  **用户系统**:
    - 支持账号密码注册与登录。
    - 支持 GitLab 第三方授权登录。
    - 提供个人中心，可修改个人资料与密码。

2.  **大纲管理**:
    - 支持大纲的创建、编辑、删除和列表展示。
    - 支持多维度筛选（名称、类型、时代、标签等）与排序。
    - 具备核心的 **AI 流式生成** 大纲内容的能力。
    - 提供基于 Markdown 的结构化内容查看与编辑功能。

3.  **基础体验**:
    - 支持明/暗两种主题模式。
    - 支持中/英双语切换。

---

## 第二部分：新版菜单结构

为支撑未来的功能扩展，我们已确定并实施了新的侧边栏菜单结构：

- **`工作台` (Workspace)**: `href: /workspace`
  - **定位**: 应用的仪表盘和启动页，提供信息概览和快捷入口。
- **`大纲` (Outlines)**: `href: /outline`
  - **定位**: 核心的灵感构思与故事结构设计中心。
- **`文稿` (Manuscripts)**: `href: /manuscripts`
  - **定位**: 基于大纲进行具体章节内容创作的管理中心。
- **`设定集` (Settings)**: `href: /settings`
  - **定位**: 创作所需的一切背景设定的"专属维基百科"，包括角色、系统、世界观等。
- **`统计` (Analytics)**: `href: /stats`
  - **定位**: 对创作过程进行数据化复盘与分析的工具。

---

## 第三部分：未来功能详细规划

### 1. `工作台` (/workspace) 模块

- **欢迎与快速入口**: 显示个性化问候，并提供“新建大纲”、“新建文稿”等核心操作的快捷按钮。
- **最近项目**: 以列表形式展示最近编辑过的文档（大纲、章节、设定），方便快速投入工作。
- **统计概览**: 以卡片和微图表形式，展示“今日字数”、“本周动态”等关键数据，作为“统计”页面的精简版。
- **创作目标/待办清单**: 提供一个简易的 To-Do List，帮助作者管理每日写作计划。
- **灵感便签**: 一个用于随手记录零散想法的区域。

### 2. `文稿` (/manuscripts) 模块

- **文稿列表**: 集中展示所有“小说项目”。
- **状态管理**: 支持按“进行中”、“已完结”、“构思中”等状态对小说项目进行筛选和管理。
- **章节组织**: 在每个文稿内部，提供创建、排序和管理章节的能力。

### 3. `设定集` (/settings) 模块

#### 界面架构设计

**首页设计** (`/settings`)

设定集首页展示小说项目列表，支持以下功能：

- **项目卡片展示**: 以卡片形式展示所有已创建的小说项目
- **项目信息**: 每个卡片显示小说名称、类型、创建时间、关联设定统计
- **设定统计**: 显示各类设定数量（角色X个、系统X个、世界X个、辅助X个）
- **设定库入口**: 提供"设定库"按钮，跳转到独立设定管理页面
- **新建项目**: 提供"创建新小说项目"按钮，弹窗式创建
- **筛选与搜索**: 支持按类型筛选、名称搜索、时间排序
- **视图模式**: 支持列表视图和网格视图切换
- **空状态处理**: 无项目时显示引导创建界面

**设定分类页** (`/settings/[projectId]`)

- **面包屑导航**: 显示 "设定集 > [项目名称]"
- **项目信息头部**: 显示项目详细信息和总设定数量
- **设定分类卡片**: 4个主要分类的大卡片展示
  - 角色设定 (`/settings/[projectId]/characters`)
  - 系统/金手指 (`/settings/[projectId]/systems`)
  - 世界背景 (`/settings/[projectId]/worlds`)
  - 辅助设定 (`/settings/[projectId]/misc`)
- **卡片内容**: 每个卡片显示该分类的设定数量和最近更新信息
- **快捷操作**: 每个卡片提供"新建"和"查看全部"操作

**独立设定库** (`/settings/library`)

为避免强耦合，提供独立的设定管理系统，采用分层架构：

**设定库首页** (`/settings/library`)

- **分类统计**: 展示四大设定分类的统计卡片（角色、系统、世界、辅助）
- **数量展示**: 显示每类设定的数量和简要描述
- **快捷入口**: 点击卡片进入对应分类的设定列表
- **总数概览**: 显示所有设定的总数量

**分类设定列表** (`/settings/library/[category]`)

- `/settings/library/characters` - 角色设定列表
- `/settings/library/systems` - 系统设定列表
- `/settings/library/worlds` - 世界设定列表
- `/settings/library/misc` - 辅助设定列表

每个分类页面包含：

- **分类标题**: 显示分类图标、名称和描述
- **筛选功能**: 支持按标签、搜索等多维度筛选
- **搜索功能**: 支持设定名称和描述的全文搜索
- **视图模式**: 支持列表视图和网格视图
- **项目关联**: 显示每个设定关联的项目数量
- **批量操作**: 支持批量编辑、删除和项目关联操作
- **新建功能**: 角色设定支持完整的创建弹框，其他分类待开发

**角色设定弹框** (`CharacterDialog`)

已实现完整的角色设定创建/编辑弹框，包含：

- **基础信息**: 角色名称、类型、性别、年龄等必填字段
- **外貌特征**: 身高、外貌描述、特殊标记等可选字段
- **性格背景**: 性格特点、出身背景、职业身份等
- **能力设定**: 实力等级、特殊能力等
- **角色关系**: 支持添加多个关系，包含关联角色、关系类型、关系描述
- **关联角色**: 既可选择现有角色，也可自定义输入任意角色名称，不强制关联角色表
- **关系类型**: 分为家庭关系、社会关系、情感关系三大类，支持自定义关系类型
- **自定义关系**: 选择"自定义..."时，显示额外输入框允许用户输入任意关系类型
- **自定义角色**: 选择"自定义角色..."时，显示输入框允许用户输入任意角色名称
- **标签系统**: 支持自定义标签便于分类和搜索
- **表单验证**: 使用Zod进行完整的数据验证

#### 核心功能模块

**角色设定** (`/settings/[projectId]/characters`)

- **基础信息**: 姓名、年龄、性别、身份、职业
- **外貌描述**: 相貌特征、身材体型、着装风格、标志性特征
- **性格特点**: 性格标签、说话方式、行为习惯、价值观念
- **背景故事**: 出身来历、成长经历、重要事件、关系网络
- **能力设定**: 实力等级、特殊技能、武器装备、战斗风格

**系统/金手指** (`/settings/[projectId]/systems`)

- **系统类型**: 升级系统、签到系统、抽奖系统、商城系统等
- **功能机制**: 运作规则、触发条件、限制约束
- **等级体系**: 境界划分、升级条件、经验获取方式
- **道具装备**: 物品分类、属性效果、获取途径
- **数值设定**: 各种参数配置、公式计算

**世界背景** (`/settings/[projectId]/worlds`)

- **世界设定**: 时代背景、地理环境、气候条件
- **势力组织**: 门派宗教、家族氏族、国家政权、商业组织
- **修炼体系**: 功法分级、修炼境界、突破条件
- **历史脉络**: 重大事件、历史人物、时间线梳理
- **文化风俗**: 社会制度、生活方式、语言文字

**辅助设定** (`/settings/[projectId]/misc`)

- **小说标签**: 热血、爽文、系统、穿越、重生、修仙等
- **分类管理**: 玄幻、都市、历史、科幻等类型维护
- **灵感记录**: 零散想法、创意片段、剧情灵感
- **参考资料**: 图片素材、文档资料、网页链接

#### 核心特性

**项目关联管理**

- 支持双重架构：项目关联设定 + 独立设定库
- 项目关联设定：强绑定到具体小说项目，便于项目管理
- 独立设定库：跨项目复用，避免重复创建相似设定
- 支持小说项目选择器，快速切换查看不同项目的设定
- 支持后期调整设定的项目关联关系
- 提供项目设定统计概览（角色数、系统数等）

**模板化创建**

- 为不同设定类型提供预设模板
- 角色模板：主角、配角、反派、路人等
- 系统模板：升级、签到、商城、抽奖等
- 创建时自动关联到当前选中的小说项目

**智能关联系统**

- **@ 引用功能**: 在大纲/正文编辑时输入 @ 触发设定搜索
- **范围限制**: @ 搜索可选择项目关联设定或设定库
- **自动插入**: 选择设定后自动插入 `[@设定名](moge://type/id)` 格式链接
- **双向关联**: 设定详情页显示所有引用该设定的大纲/章节位置

**AI 生成增强**

- 生成大纲时自动获取项目关联的所有设定作为上下文
- 支持设定摘要注入，提升 AI 生成内容的一致性
- 智能识别相关设定，优先使用高相关度的设定信息
- 生成结果自动解析并建立 @ 引用关系

**关系链接**

- 角色间的关系图谱展示
- 设定间的引用关系管理
- 设定使用频次统计和热度分析
- 项目内设定的关联度可视化

**视图模式**

- **项目切换栏**: 顶部显示当前项目选择器和设定统计
- **卡片视图**: 适合浏览概览，突出图片和核心信息
- **表格视图**: 适合数据对比，支持排序和高级筛选
- **详情视图**: 完整信息展示，支持富文本编辑

**搜索筛选**

- 按类型、标签、创建时间等维度筛选
- 全文搜索设定内容和关键词
- 项目关联设定：限制当前项目范围
- 独立设定库：支持跨项目搜索
- 收藏夹和常用设定快速访问
- 支持跨项目设定复制和导入

**数据管理**

- 设定导出为 JSON/Markdown 格式
- 支持设定模板保存和复用
- 设定版本历史和回滚功能
- 批量操作：标签管理、项目迁移等

#### 界面展示设计

**标签页内容布局**

- **工具栏区域**: 搜索框、标签筛选、排序选择、新建按钮
- **视图切换**: 卡片视图、列表视图两种模式
- **内容展示**: 根据视图模式展示设定列表
- **分页控件**: 支持大量设定的分页浏览

**两种视图模式**

- **卡片视图**: 网格布局，显示设定卡片，适合浏览概览
  - 桌面端 4 列，平板端 2-3 列，手机端 1 列
  - 显示名称、摘要、标签、操作菜单
  - 支持拖拽排序和批量选择
- **列表视图**: 紧凑列表，显示核心信息，适合快速查看
  - 头像、名称、摘要、标签、快捷操作按钮
  - 适合在有限空间内浏览大量设定
  - 每行显示完整信息，操作更直观

**搜索筛选功能**

- **搜索框**: 支持设定名称、描述内容的全文搜索
- **标签筛选**: 多选标签，支持 AND/OR 逻辑筛选
- **排序方式**: 按名称、创建时间、更新时间、使用频次排序
- **高级筛选**: 按设定类型、项目关联、收藏状态等筛选

**空状态处理**

- 针对不同设定类型显示对应的空状态提示
- 提供快速创建入口和使用指导
- 显示创建建议和模板推荐

**响应式适配**

- 桌面端：完整功能和多列布局
- 平板端：简化工具栏，适中的列数

**子路由结构**: 采用 `settings/characters/[id]` 清晰层级，分离"主页"、"列表页"和"详情页"

### 4. `统计` (/stats) 模块

- **深度分析**: 提供独立、强大的数据分析功能。
- **功能**: 支持按时间范围（本周、本月、本年）查看详细的字数趋势图、项目贡献度分析、写作活跃时间分布等。

---

## 第四部分：全局核心系统规划

### `@` 智能引用系统

这是打通所有模块、提升产品价值的核心系统。

- **目标**: 实现 `设定集`、`大纲`、`正文` 之间的无缝链接。
- **核心流程**:
  1.  **触发与插入**: 在任何编辑器中输入 `@`，触发全局设定搜索，选择后插入一个包含唯一ID的稳定链接（如 `[@风雪城](moge://item/uuid-xxx)`）。
  2.  **悬浮与跳转**: 在阅读时，鼠标悬浮于 `@链接` 上可预览设定简介卡片；点击则直接跳转至该设定的详情页。
  3.  **反向链接**: 在设定的详情页，能自动展示所有引用了该设定的“出场章节”列表。
- **技术要点**: 需要后端提供统一搜索接口、前端实现编辑器插件和 Markdown 自定义渲染组件。

---

## 第五部分：实施策略建议

建议采用分阶段、迭代的方式进行开发：

1.  **第一阶段 (基础建设)**:
    - 搭建 `文稿` 和 `设定集` 模块的基础页面和路由结构。
    - 实现 `设定集` 的项目关联功能：项目选择器、设定与项目的绑定关系。
    - 实现 `设定集` 模块的模板化创建和列表/表格视图功能。
    - 实现 `文稿` 模块的列表及状态管理。

2.  **第二阶段 (核心价值)**:
    - 实现 `@` 智能引用系统的 MVP 版本（项目范围内的搜索、插入和点击跳转）。
    - 实现 AI 生成时的设定上下文注入功能。
    - 实现 `工作台` 的"最近项目"和"统计概览"模块。

3.  **第三阶段 (体验增强)**:
    - 为 `@` 系统增加悬浮预览卡片和反向链接功能。
    - 实现设定使用统计和关联度分析。
    - 完善独立的 `统计` 页面，提供深度数据分析。
    - 完成 `工作台` 的其余模块。
