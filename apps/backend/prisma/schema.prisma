// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// * ==================== 配置 ====================
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// * ==================== 用户表 ====================
model users {
  id              Int        @id @default(autoincrement())
  /// 用户登录账号，全局唯一
  username        String     @unique
  /// 用户邮箱，第三方登录时使用，全局唯一
  email           String?    @unique
  /// 邮箱验证通过的时间，未验证则为空
  emailVerifiedAt DateTime?  @map("email_verified_at")
  /// bcrypt 哈希后的密码；OAuth 用户此处为空
  passwordHash    String?    @map("password_hash")
  /// 昵称
  name            String?
  /// 头像 URL
  avatarUrl       String?    @map("avatar_url")
  /// 记录创建时间
  createdAt       DateTime   @default(now()) @map("created_at")
  /// 记录更新时间
  updatedAt       DateTime   @updatedAt @map("updated_at")
  /// 该用户绑定的所有第三方账号
  accounts        accounts[]
  /// 所属的所有大纲
  outlines        outline[]
  /// 所属的所有项目
  projects        projects[]
  /// 所属的所有角色设定
  characterSettings character_settings[]
  /// 所属的所有系统设定
  systemSettings  system_settings[]
  /// 所属的所有世界设定
  worldSettings   world_settings[]
  /// 所属的所有辅助设定
  miscSettings    misc_settings[]
}

// * ==================== 第三方账号关联表 ====================
model accounts {
  id                Int      @id @default(autoincrement())
  /// 关联的用户 id
  userId            Int      @map("user_id")
  /// 第三方提供商名称，例如 github / gitlab 
  provider          String
  /// 第三方返回的 uid（字符串）
  providerAccountId String   @map("provider_account_id")
  /// 原始 provider 数据，存 tokens、avatar_url 等 JSON
  providerData      Json?    @map("provider_data")
  /// 创建时间
  createdAt         DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt         DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user              users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// * ==================== 字典管理 ====================
/// 字典分类表
model dict_categories {
  id          Int          @id @default(autoincrement())
  /// 分类编码，如 'novel_types'
  code        String       @unique
  /// 分类名称，如 '小说类型'
  name        String
  /// 描述
  description String?
  /// 创建时间
  createdAt   DateTime     @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime     @updatedAt @map("updated_at")
  /// 字典项
  items       dict_items[]
}

/// 字典项表
model dict_items {
  id           Int             @id @default(autoincrement())
  /// 所属分类编码
  categoryCode String          @map("category_code")
  /// 项目编码，如 'sci_fi'
  code         String
  /// 显示标签，如 '科幻'
  label        String
  /// 存储值
  value        String?
  /// 描述信息
  description  String?
  /// 排序
  sortOrder    Int             @default(0) @map("sort_order")
  /// 是否启用
  isEnabled    Boolean         @default(true) @map("is_enabled")
  /// 创建时间
  createdAt    DateTime        @default(now()) @map("created_at")
  /// 更新时间
  updatedAt    DateTime        @updatedAt @map("updated_at")
  /// 所属分类
  category     dict_categories @relation(fields: [categoryCode], references: [code], onDelete: Cascade)

  @@unique([categoryCode, code])
}

// * ==================== 小说大纲 ====================

/// 小说大纲表
model outline {
  id        Int           @id @default(autoincrement())
  /// 小说名称
  name      String
  /// 小说类型（存 label）
  type      String
  /// 故事时代背景
  era       String?
  /// 核心冲突描述
  conflict  String?       @db.Text
  /// 标签数组（Pg text[]）
  tags      String[]      @default([])
  /// 备注信息
  remark    String?       @db.Text
  /// 业务生命周期状态
  status    OutlineStatus @default(DRAFT)
  /// 所属用户 ID
  userId    Int           @map("user_id")
  /// 创建人关联
  user      users         @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 记录创建时间
  createdAt DateTime      @default(now()) @map("created_at")
  /// 记录更新时间
  updatedAt DateTime      @updatedAt @map("updated_at")
  /// 大纲内容（一对一）
  content   outline_content?
  /// 所属的卷
  volumes   outline_volume[]
  /// 无卷的直接章节（序章、后记等）
  chapters  outline_chapter[]

  @@index([userId, status])
  @@index([createdAt])
}

/// 大纲内容表
model outline_content {
  id        Int      @id @default(autoincrement())
  /// 所属大纲ID
  outlineId Int      @unique @map("outline_id")
  /// Markdown全文内容
  content   String   @db.Text
  /// 内容版本号
  version   Int      @default(1)
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @updatedAt @map("updated_at")
  /// 所属大纲
  outline   outline  @relation(fields: [outlineId], references: [id], onDelete: Cascade)
  /// 版本历史
  versions  outline_content_version[]
}

/// 卷表
model outline_volume {
  id        Int     @id @default(autoincrement())
  /// 所属大纲ID
  outlineId Int     @map("outline_id")
  /// 卷名，如"第一卷 风起云涌"
  title     String
  /// 卷描述
  description String? @db.Text
  /// 卷排序（使用十进制避免并发冲突）
  sortOrder Decimal @map("sort_order") @db.Decimal(10, 5)
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @updatedAt @map("updated_at")
  /// 所属大纲
  outline   outline  @relation(fields: [outlineId], references: [id], onDelete: Cascade)
  /// 卷下的章节
  chapters  outline_chapter[]

  @@index([outlineId, sortOrder])
}

/// 章节表（元数据）
/// 注意：需在数据库迁移时添加 CHECK 约束：CHECK (outline_id IS NOT NULL OR volume_id IS NOT NULL)
model outline_chapter {
  id        Int            @id @default(autoincrement())
  /// 所属大纲ID（用于无卷章节，如序章、后记）
  outlineId Int?           @map("outline_id")
  /// 所属卷ID（用于正文章节）
  volumeId  Int?           @map("volume_id")
  /// 章名，如"第一章 初入江湖"
  title     String
  /// 章节在卷内或大纲内的排序（使用十进制避免并发冲突）
  sortOrder Decimal        @map("sort_order") @db.Decimal(10, 5)
  /// 创建时间
  createdAt DateTime       @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime       @updatedAt @map("updated_at")
  /// 所属大纲（无卷章节）
  outline   outline?       @relation(fields: [outlineId], references: [id], onDelete: Cascade)
  /// 所属卷
  volume    outline_volume? @relation(fields: [volumeId], references: [id], onDelete: Cascade)
  /// 章节内容（一对一）
  content   outline_chapter_content?

  @@index([outlineId, sortOrder])
  @@index([volumeId, sortOrder])
  @@map("outline_chapter")
}

/// 章节内容表
model outline_chapter_content {
  id        Int     @id @default(autoincrement())
  /// 所属章节ID
  chapterId Int     @unique @map("chapter_id")
  /// 章节内容
  content   String  @db.Text
  /// 内容版本号
  version   Int     @default(1)
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @updatedAt @map("updated_at")
  /// 所属章节
  chapter   outline_chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  /// 版本历史
  versions  outline_chapter_content_version[]
}

/// 章节内容版本历史表
model outline_chapter_content_version {
  id        Int     @id @default(autoincrement())
  /// 所属章节内容ID
  contentId Int     @map("content_id")
  /// 版本号
  version   Int
  /// 该版本的内容
  content   String  @db.Text
  /// 版本创建时间
  createdAt DateTime @default(now()) @map("created_at")
  /// 所属章节内容
  contentRecord outline_chapter_content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, version])
  @@index([contentId, version])
}

/// 大纲内容版本历史表
model outline_content_version {
  id        Int      @id @default(autoincrement())
  /// 所属大纲内容ID
  contentId Int      @map("content_id")
  /// 版本号
  version   Int
  /// 该版本的内容
  content   String   @db.Text
  /// 版本创建时间
  createdAt DateTime @default(now()) @map("created_at")
  /// 所属大纲内容
  outlineContent outline_content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, version])
  @@index([contentId, version])
}

/// 大纲业务状态枚举
enum OutlineStatus {
  DRAFT       // 草稿 - 刚创建
  GENERATING  // 生成中 - AI生成过程中
  GENERATED   // 已生成 - AI生成完成但未保存
  PUBLISHED   // 已发布 - 用户确认保存
  DISCARDED   // 已放弃 - 软删除
}

// * ==================== 设定集系统 ====================

/// 小说项目表
model projects {
  id          Int      @id @default(autoincrement())
  /// 项目名称
  name        String
  /// 项目类型（小说类型）
  type        String
  /// 项目描述
  description String?  @db.Text
  /// 项目标签
  tags        String[] @default([])
  /// 关联的角色设定ID列表
  characters  String[] @default([])
  /// 关联的系统设定ID列表
  systems     String[] @default([])
  /// 关联的世界设定ID列表
  worlds      String[] @default([])
  /// 关联的辅助设定ID列表
  misc        String[] @default([])
  /// 所属用户ID
  userId      Int      @map("user_id")
  /// 创建时间
  createdAt   DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

/// 角色设定表
model character_settings {
  id                Int      @id @default(autoincrement())
  /// 角色名称
  name              String
  /// 角色类型
  type              String?
  /// 性别
  gender            String?
  /// 年龄
  age               String?
  /// 身高
  height            String?
  /// 外貌描述
  appearance        String?  @db.Text
  /// 性格特点
  personality       String?  @db.Text
  /// 出身背景
  background        String?  @db.Text
  /// 职业身份
  occupation        String?
  /// 实力等级
  powerLevel        String?
  /// 特殊能力
  abilities         String?  @db.Text
  /// 角色关系（JSON数组）
  relationships     Json?
  /// 标签
  tags              String[] @default([])
  /// 备注
  remarks           String?  @db.Text
  /// 所属用户ID
  userId            Int      @map("user_id")
  /// 创建时间
  createdAt         DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt         DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user              users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
}

/// 系统设定表
model system_settings {
  id              Int      @id @default(autoincrement())
  /// 系统名称
  name            String
  /// 系统类型
  type            String?
  /// 系统描述
  description     String?  @db.Text
  /// 功能模块（JSON数组）
  modules         Json?
  /// 等级体系（JSON数组）
  levels          Json?
  /// 道具装备（JSON数组）
  items           Json?
  /// 数值参数（JSON数组）
  parameters      Json?
  /// 运作规则
  rules           String?  @db.Text
  /// 触发条件
  triggers        String?  @db.Text
  /// 限制约束
  constraints     String?  @db.Text
  /// 标签
  tags            String[] @default([])
  /// 备注
  remarks         String?  @db.Text
  /// 所属用户ID
  userId          Int      @map("user_id")
  /// 创建时间
  createdAt       DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt       DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user            users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
}

/// 世界设定表
model world_settings {
  id                Int      @id @default(autoincrement())
  /// 世界名称
  name              String
  /// 世界类型
  type              String?
  /// 时代背景
  era               String?
  /// 世界描述
  description       String?  @db.Text
  /// 地理环境（JSON数组）
  geography         Json?
  /// 政治势力（JSON数组）
  politics          Json?
  /// 文化体系（JSON数组）
  culture           Json?
  /// 修炼/力量体系（JSON数组）
  powerSystem       Json?    @map("power_system")
  /// 历史脉络（JSON对象）
  history           Json?
  /// 标签
  tags              String[] @default([])
  /// 备注
  remarks           String?  @db.Text
  /// 所属用户ID
  userId            Int      @map("user_id")
  /// 创建时间
  createdAt         DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt         DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user              users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
}

/// 辅助设定表
model misc_settings {
  id              Int      @id @default(autoincrement())
  /// 设定名称
  name            String
  /// 设定类型
  type            String?
  /// 设定描述
  description     String?  @db.Text
  /// 灵感记录（JSON数组）
  inspirations    Json?
  /// 参考资料（JSON数组）
  references      Json?
  /// 创作笔记（JSON数组）
  notes           Json?
  /// 专业术语（JSON数组）
  terminology     Json?
  /// 模板库（JSON数组）
  templates       Json?
  /// 项目标签（JSON数组）
  projectTags     Json?    @map("project_tags")
  /// 标签
  tags            String[] @default([])
  /// 备注
  remarks         String?  @db.Text
  /// 所属用户ID
  userId          Int      @map("user_id")
  /// 创建时间
  createdAt       DateTime @default(now()) @map("created_at")
  /// 更新时间
  updatedAt       DateTime @updatedAt @map("updated_at")
  /// 所属用户
  user            users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
}
